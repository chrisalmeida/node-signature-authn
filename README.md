# Node Signature Anthentication

An express.js signature authentication implementation using node, postgres and hashicorp vault.

## Project Mission

This project aims to provide a simple and secure example of API HMAC signature authentication using common and open source technologies.

Vault will be used so that an application's credentials can remain encrypted in transit or at rest.

The following API uses [knex](http://knexjs.org/) so that Postgres can easily be swapped out for MySQL or SQLite if desired.

---

## Requirements

The following dependencies will be needed to run this project successfully.

### Node

- #### Installation
  Node >= **v12.18.3** was used in development.
  See the [Node.js website](https://nodejs.org/) and follow the instructions for installation.

### Vault

- #### Installation
  Vault >= **v1.5.0** was used in development.
  See the [Hashicorp Vault website](https://learn.hashicorp.com/tutorials/vault/getting-started-install) and follow the instructions for installation.

### Postgres

- #### Installation
  Postgres >= **12.2** was used in development.
  See the [Postgres website](https://www.postgresql.org/download/) and follow the instructions for installation.

### Environment

Ensure that you have a **.env** file in the root of this project.
The following variables are required to be set:

```shell
VAULT_ADDRESS=http://localhost:8200
VAULT_TOKEN=devtoken
PGDBNAME=
PGUSER=
PGPASSWORD=
```

## Up and Running

### Postgres

Make sure that Postgres is running and that you have created a database which matches **PGDBNAME**.

```
psql postgres
CREATE DATABASE mydbname;
```

### Vault

Let's start our Vault instance

```shell
vault server -dev -dev-root-token-id=devtoken -dev-kv-v1
```

### NPM

Install node modules

```shell
npm ci
```

### Migrations

In this step we'll seed our database with a few applications and API keys at the same time we will insert autogenerated credential paths
Run the database migrations and seeds.

```shell
npm run db:migrate && npm run db:seed
```

### Server

Start the HTTP server

```shell
npm run dev
```

### Vault UI

You should now be able to browse to your local [Vault UI](http://localhost:8200) and enter your **VAULT_TOKEN**

You should now see unique paths for each application's credentials. This is where the application secret is stored. These paths can be referenced to by the **credentials_path** column in our database's **applications** table.

## Signature Construction

```javascript
const crypto = require("crypto");
// Find an application in the database and use it's API key here
const apiKey = "<API KEY FROM DB>";
// Using the selected application's credentials_path, find the secret in vault and use it here
const secret = "<SECRET FROM VAULT>";

const timestamp = Date.now();
const method = "GET";
const path = "/";
const body = JSON.stringify({});

const signature = crypto
  .createHmac("sha256", secret)
  .update(`${timestamp}${method}${path}${body}`)
  .digest("hex");

// Output a curl command
console.log(
  `curl http://localhost:3000 -H 'x-api-key: ${apiKey}' -H 'x-api-signature: ${signature}' -H 'x-api-timestamp: ${timestamp}'`
);
```
